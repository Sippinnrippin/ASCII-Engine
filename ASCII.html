<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'unsafe-inline'; script-src 'unsafe-inline'; img-src 'self' blob: data:;">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">
<title>ASCII Engine</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Bebas+Neue&display=swap');

  :root {
    --bg: #0a0a0a;
    --surface: #111;
    --border: #222;
    --accent: #00ff88;
    --accent2: #ff3366;
    --text: #c8c8c8;
    --dim: #444;
    --mono: 'Share Tech Mono', monospace;
    --display: 'Bebas Neue', sans-serif;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  html, body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    height: 100%;
    overflow-x: hidden;
  }

  body {
    display: grid;
    grid-template-rows: auto 1fr auto;
    min-height: 100vh;
  }

  header {
    border-bottom: 1px solid var(--border);
    padding: 1.2rem 2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    background: var(--surface);
  }

  header h1 {
    font-family: var(--display);
    font-size: 2rem;
    letter-spacing: 0.1em;
    color: var(--accent);
    line-height: 1;
  }

  header span {
    font-size: 0.7rem;
    color: var(--dim);
    letter-spacing: 0.2em;
    text-transform: uppercase;
    border: 1px solid var(--border);
    padding: 0.2rem 0.5rem;
    border-radius: 2px;
  }

  main {
    display: grid;
    grid-template-columns: 280px 1fr;
    overflow: hidden;
  }

  /* SIDEBAR */
  aside {
    background: var(--surface);
    border-right: 1px solid var(--border);
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    overflow-y: auto;
  }

  .section-label {
    font-size: 0.65rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--dim);
    margin-bottom: 0.75rem;
  }

  /* DROP ZONE */
  #dropzone {
    border: 1px dashed var(--dim);
    border-radius: 4px;
    padding: 2rem 1rem;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    position: relative;
    overflow: hidden;
  }

  #dropzone:hover, #dropzone.dragover {
    border-color: var(--accent);
    background: rgba(0,255,136,0.03);
  }

  #dropzone input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  #dropzone .dz-icon {
    font-size: 2rem;
    color: var(--dim);
    margin-bottom: 0.5rem;
    display: block;
    transition: color 0.2s;
  }

  #dropzone:hover .dz-icon { color: var(--accent); }

  #dropzone p {
    font-size: 0.75rem;
    color: var(--dim);
    line-height: 1.5;
  }

  #dropzone .filename {
    font-size: 0.7rem;
    color: var(--accent);
    margin-top: 0.5rem;
    word-break: break-all;
  }

  /* CONTROLS */
  .control-group { display: flex; flex-direction: column; gap: 0.4rem; }

  label {
    font-size: 0.7rem;
    color: var(--dim);
    letter-spacing: 0.15em;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  label span.val {
    color: var(--accent);
    font-size: 0.8rem;
  }

  input[type="range"] {
    width: 100%;
    accent-color: var(--accent);
    background: transparent;
    height: 4px;
    cursor: pointer;
    appearance: none;
    border-radius: 2px;
    background: var(--border);
    outline: none;
  }

  input[type="range"]::-webkit-slider-thumb {
    appearance: none;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    transition: transform 0.1s;
  }

  input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.3); }

  select {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 0.4rem 0.6rem;
    font-family: var(--mono);
    font-size: 0.75rem;
    border-radius: 3px;
    cursor: pointer;
    outline: none;
    transition: border-color 0.2s;
  }

  select:focus { border-color: var(--accent); }

  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.7rem;
    color: var(--dim);
    letter-spacing: 0.1em;
  }

  .toggle {
    position: relative;
    width: 36px;
    height: 18px;
  }

  .toggle input { opacity: 0; width: 0; height: 0; }

  .toggle-slider {
    position: absolute;
    inset: 0;
    background: var(--border);
    border-radius: 18px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .toggle-slider::before {
    content: '';
    position: absolute;
    width: 12px;
    height: 12px;
    background: var(--dim);
    border-radius: 50%;
    top: 3px;
    left: 3px;
    transition: transform 0.2s, background 0.2s;
  }

  .toggle input:checked + .toggle-slider { background: rgba(0,255,136,0.2); }
  .toggle input:checked + .toggle-slider::before {
    transform: translateX(18px);
    background: var(--accent);
  }

  /* BUTTONS */
  .btn {
    display: block;
    width: 100%;
    padding: 0.65rem;
    font-family: var(--display);
    font-size: 1.1rem;
    letter-spacing: 0.15em;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    transition: opacity 0.15s, transform 0.1s;
    text-align: center;
  }

  .btn:active { transform: scale(0.98); }
  .btn:disabled { opacity: 0.3; cursor: not-allowed; }

  .btn-primary {
    background: var(--accent);
    color: #000;
  }

  .btn-secondary {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 0.75rem;
    letter-spacing: 0.1em;
  }

  .btn-secondary:hover:not(:disabled) { border-color: var(--accent2); color: var(--accent2); }

  /* OUTPUT AREA */
  #output-area {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--bg);
    position: relative;
  }

  #output-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1.5rem;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    gap: 1rem;
    flex-shrink: 0;
  }

  #output-toolbar .info {
    font-size: 0.65rem;
    color: var(--dim);
    letter-spacing: 0.1em;
  }

  #output-toolbar .info span { color: var(--accent); }

  #toolbar-actions { display: flex; gap: 0.5rem; }

  .icon-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--dim);
    padding: 0.35rem 0.7rem;
    font-size: 0.7rem;
    font-family: var(--mono);
    letter-spacing: 0.1em;
    cursor: pointer;
    border-radius: 3px;
    transition: color 0.15s, border-color 0.15s;
  }

  .icon-btn:hover { color: var(--accent); border-color: var(--accent); }

  #canvas-container {
    flex: 1;
    overflow: auto;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 2rem;
  }

  #ascii-canvas {
    display: none;
  }

  #ascii-output {
    font-family: var(--mono);
    line-height: 1.15;
    white-space: pre;
    font-size: 7px;
    color: var(--accent);
    background: var(--bg);
    display: block;
    tab-size: 1;
    transform-origin: top left;
    user-select: all;
  }

  #placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: 1rem;
    color: var(--dim);
  }

  #placeholder .big {
    font-family: var(--display);
    font-size: 4rem;
    color: var(--border);
    letter-spacing: 0.1em;
  }

  #placeholder p { font-size: 0.75rem; letter-spacing: 0.2em; }

  /* PROGRESS */
  #progress-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 2px;
    background: var(--accent);
    width: 0%;
    transition: width 0.15s;
    display: none;
  }

  /* TOAST */
  #toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: var(--surface);
    border: 1px solid var(--accent);
    color: var(--accent);
    padding: 0.6rem 1.2rem;
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    border-radius: 3px;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    z-index: 999;
  }

  footer {
    border-top: 1px solid var(--border);
    padding: 0.6rem 2rem;
    font-size: 0.6rem;
    color: var(--dim);
    letter-spacing: 0.15em;
    background: var(--surface);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .divider {
    height: 1px;
    background: var(--border);
    margin: 0 -1.5rem;
  }

  /* THEME PANEL */
  #theme-btn {
    margin-left: auto;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--dim);
    padding: 0.3rem 0.8rem;
    font-family: var(--mono);
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    cursor: pointer;
    border-radius: 3px;
    transition: color 0.15s, border-color 0.15s;
  }
  #theme-btn:hover { color: var(--accent); border-color: var(--accent); }

  #theme-panel {
    display: none;
    position: fixed;
    top: 0; right: 0;
    width: 260px;
    height: 100vh;
    background: #0d0d0d;
    border-left: 1px solid var(--border);
    z-index: 100;
    flex-direction: column;
    overflow-y: auto;
  }
  #theme-panel.open { display: flex; }

  #theme-panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.2rem;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  #theme-panel-header span {
    font-size: 0.65rem;
    letter-spacing: 0.3em;
    color: var(--dim);
    text-transform: uppercase;
  }

  #theme-close {
    background: none;
    border: none;
    color: var(--dim);
    cursor: pointer;
    font-size: 1rem;
    padding: 0;
    line-height: 1;
    transition: color 0.15s;
  }
  #theme-close:hover { color: var(--accent2); }

  #theme-panel-body {
    padding: 1.2rem;
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
    flex: 1;
  }

  .theme-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
  }

  .theme-row label {
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    color: var(--dim);
    flex: 1;
    display: block;
    justify-content: unset;
  }

  .color-swatch-wrap {
    position: relative;
    width: 32px;
    height: 22px;
    border-radius: 3px;
    border: 1px solid var(--border);
    overflow: hidden;
    cursor: pointer;
    flex-shrink: 0;
  }

  .color-swatch-wrap input[type="color"] {
    position: absolute;
    inset: -4px;
    width: calc(100% + 8px);
    height: calc(100% + 8px);
    border: none;
    padding: 0;
    cursor: pointer;
    background: none;
  }

  .theme-presets {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.4rem;
  }

  .preset-btn {
    padding: 0.45rem 0.4rem;
    font-family: var(--mono);
    font-size: 0.6rem;
    letter-spacing: 0.1em;
    border-radius: 3px;
    cursor: pointer;
    border: 1px solid transparent;
    transition: border-color 0.15s, opacity 0.15s;
    text-align: center;
  }
  .preset-btn:hover { opacity: 0.85; border-color: rgba(255,255,255,0.2); }

  #theme-reset {
    margin-top: auto;
    width: 100%;
    padding: 0.55rem;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--dim);
    font-family: var(--mono);
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    cursor: pointer;
    border-radius: 3px;
    transition: color 0.15s, border-color 0.15s;
  }
  #theme-reset:hover { color: var(--accent2); border-color: var(--accent2); }

  #theme-overlay {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 99;
    background: rgba(0,0,0,0.4);
  }
  #theme-overlay.open { display: block; }

  @media (max-width: 700px) {
    main { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
    aside { border-right: none; border-bottom: 1px solid var(--border); max-height: 300px; }
    #theme-panel { width: 100%; border-left: none; border-top: 1px solid var(--border); top: auto; bottom: 0; height: 70vh; }
  }
</style>
</head>
<body>

<header>
  <h1>ASCII ENGINE</h1>
  <span>image → text art</span>
  <button id="theme-btn" aria-label="Open theme editor">⬡ THEME</button>
</header>

<main>
  <aside>
    <div>
      <p class="section-label">// input</p>
      <div id="dropzone">
        <input type="file" id="file-input" accept="image/png,image/jpeg,image/webp,image/gif,image/bmp" aria-label="Upload image">
        <span class="dz-icon">⬡</span>
        <p>Drop image here<br>or click to browse</p>
        <p class="filename" id="filename-display"></p>
      </div>
    </div>

    <div class="divider"></div>

    <div>
      <p class="section-label">// parameters</p>
      <div style="display:flex;flex-direction:column;gap:1rem;">

        <div class="control-group">
          <label>WIDTH (chars) <span class="val" id="val-width">120</span></label>
          <input type="range" id="ctrl-width" min="20" max="300" value="120" step="5">
        </div>

        <div class="control-group">
          <label>BRIGHTNESS <span class="val" id="val-brightness">100</span>%</label>
          <input type="range" id="ctrl-brightness" min="50" max="200" value="100" step="5">
        </div>

        <div class="control-group">
          <label>CONTRAST <span class="val" id="val-contrast">100</span>%</label>
          <input type="range" id="ctrl-contrast" min="50" max="200" value="100" step="5">
        </div>

        <div class="control-group">
          <label>CHAR SET</label>
          <select id="ctrl-charset">
            <option value="standard">Standard (70 chars)</option>
            <option value="simple">Simple (10 chars)</option>
            <option value="blocks">Block Elements</option>
            <option value="binary">Binary (01)</option>
            <option value="hex">Hex (0-F)</option>
            <option value="braille">Braille Dots</option>
          </select>
        </div>

        <div class="toggle-row">
          <span>INVERT</span>
          <label class="toggle">
            <input type="checkbox" id="ctrl-invert">
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="toggle-row">
          <span>COLOR</span>
          <label class="toggle">
            <input type="checkbox" id="ctrl-color">
            <span class="toggle-slider"></span>
          </label>
        </div>

      </div>
    </div>

    <div class="divider"></div>

    <div style="display:flex;flex-direction:column;gap:0.5rem;">
      <button class="btn btn-primary" id="btn-render" disabled>RENDER</button>
      <button class="btn btn-secondary" id="btn-copy" disabled>COPY TEXT</button>
      <button class="btn btn-secondary" id="btn-download" disabled>DOWNLOAD .TXT</button>
    </div>
  </aside>

  <section id="output-area">
    <div id="output-toolbar">
      <div class="info" id="output-info"><span>—</span> ready</div>
      <div id="toolbar-actions">
        <button class="icon-btn" id="btn-zoom-out" title="Zoom out">−</button>
        <button class="icon-btn" id="btn-zoom-reset" title="Reset zoom">100%</button>
        <button class="icon-btn" id="btn-zoom-in" title="Zoom in">+</button>
      </div>
    </div>

    <div id="canvas-container">
      <div id="placeholder">
        <div class="big">[ ]</div>
        <p>upload an image to begin</p>
      </div>
      <pre id="ascii-output" aria-label="ASCII art output"></pre>
    </div>

    <canvas id="ascii-canvas" aria-hidden="true"></canvas>
    <div id="progress-bar"></div>
  </section>
</main>

<footer>
  <span>ASCII ENGINE // CLIENT-SIDE ONLY // NO DATA UPLOADED</span>
  <span>Created by Sippinnrippin ZF</span>
  <span id="perf-info"></span>
</footer>

<div id="toast" role="status" aria-live="polite"></div>

<div id="theme-overlay" aria-hidden="true"></div>

<aside id="theme-panel" role="dialog" aria-label="Theme editor">
  <div id="theme-panel-header">
    <span>// theme editor</span>
    <button id="theme-close" aria-label="Close theme editor">✕</button>
  </div>
  <div id="theme-panel-body">

    <div>
      <p class="section-label">presets</p>
      <div class="theme-presets">
        <button class="preset-btn" data-preset="default"  style="background:#111;color:#00ff88;border-color:#222">Default</button>
        <button class="preset-btn" data-preset="light"    style="background:#f5f5f0;color:#1a1a1a;border-color:#ddd">Light</button>
        <button class="preset-btn" data-preset="amber"    style="background:#0f0a00;color:#ffb300;border-color:#2a1f00">Amber</button>
        <button class="preset-btn" data-preset="cyan"     style="background:#00080f;color:#00e5ff;border-color:#002030">Cyan</button>
        <button class="preset-btn" data-preset="rose"     style="background:#0f0008;color:#ff4d88;border-color:#2a0018">Rose</button>
        <button class="preset-btn" data-preset="matrix"   style="background:#000;color:#39ff14;border-color:#0a2a00">Matrix</button>
      </div>
    </div>

    <div class="divider"></div>

    <div>
      <p class="section-label">custom colors</p>
      <div style="display:flex;flex-direction:column;gap:0.75rem;">
        <div class="theme-row">
          <label>Background</label>
          <div class="color-swatch-wrap"><input type="color" id="tc-bg" value="#0a0a0a"></div>
        </div>
        <div class="theme-row">
          <label>Surface / Sidebar</label>
          <div class="color-swatch-wrap"><input type="color" id="tc-surface" value="#111111"></div>
        </div>
        <div class="theme-row">
          <label>Border</label>
          <div class="color-swatch-wrap"><input type="color" id="tc-border" value="#222222"></div>
        </div>
        <div class="theme-row">
          <label>Primary Accent</label>
          <div class="color-swatch-wrap"><input type="color" id="tc-accent" value="#00ff88"></div>
        </div>
        <div class="theme-row">
          <label>Secondary Accent</label>
          <div class="color-swatch-wrap"><input type="color" id="tc-accent2" value="#ff3366"></div>
        </div>
        <div class="theme-row">
          <label>Text</label>
          <div class="color-swatch-wrap"><input type="color" id="tc-text" value="#c8c8c8"></div>
        </div>
        <div class="theme-row">
          <label>Dim / Labels</label>
          <div class="color-swatch-wrap"><input type="color" id="tc-dim" value="#444444"></div>
        </div>
        <div class="theme-row">
          <label>ASCII Output Color</label>
          <div class="color-swatch-wrap"><input type="color" id="tc-ascii" value="#00ff88"></div>
        </div>
      </div>
    </div>

    <button id="theme-reset">RESET TO DEFAULT</button>
  </div>
</aside>

<script>
(() => {
  'use strict';

  // ── Constants ──────────────────────────────────────────────────────────────
  const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20 MB
  const ALLOWED_TYPES = new Set(['image/png','image/jpeg','image/webp','image/gif','image/bmp']);
  const CHAR_SETS = {
    standard: ' .\'`^",:;Il!i><~+_-?][}{1)(|/tfjrxnuvczXYUJCLQ0OZmwqpdbkhao*#MW&8%B@$',
    simple:   ' .:-=+*#%@',
    blocks:   ' ░▒▓█',
    binary:   '01',
    hex:      '0123456789ABCDEF',
    braille:  '⠀⠁⠂⠃⠄⠅⠆⠇⠈⠉⠊⠋⠌⠍⠎⠏⠐⠑⠒⠓⠔⠕⠖⠗⠘⠙⠚⠛⠜⠝⠞⠟⠠⠡⠢⠣⠤⠥⠦⠧⠨⠩⠪⠫⠬⠭⠮⠯⠰⠱⠲⠳⠴⠵⠶⠷⠸⠹⠺⠻⠼⠽⠾⠿',
  };

  // ── State ──────────────────────────────────────────────────────────────────
  let imageLoaded = false;
  let lastResult = '';
  let zoom = 1;

  // ── DOM refs ───────────────────────────────────────────────────────────────
  const fileInput     = document.getElementById('file-input');
  const dropzone      = document.getElementById('dropzone');
  const filenameDisp  = document.getElementById('filename-display');
  const canvas        = document.getElementById('ascii-canvas');
  const ctx           = canvas.getContext('2d', { willReadFrequently: true });
  const asciiOut      = document.getElementById('ascii-output');
  const placeholder   = document.getElementById('placeholder');
  const btnRender     = document.getElementById('btn-render');
  const btnCopy       = document.getElementById('btn-copy');
  const btnDownload   = document.getElementById('btn-download');
  const btnZoomIn     = document.getElementById('btn-zoom-in');
  const btnZoomOut    = document.getElementById('btn-zoom-out');
  const btnZoomReset  = document.getElementById('btn-zoom-reset');
  const progressBar   = document.getElementById('progress-bar');
  const outputInfo    = document.getElementById('output-info');
  const perfInfo      = document.getElementById('perf-info');
  const toast         = document.getElementById('toast');

  const ctrl = {
    width:      document.getElementById('ctrl-width'),
    brightness: document.getElementById('ctrl-brightness'),
    contrast:   document.getElementById('ctrl-contrast'),
    charset:    document.getElementById('ctrl-charset'),
    invert:     document.getElementById('ctrl-invert'),
    color:      document.getElementById('ctrl-color'),
  };

  const valEl = {
    width:      document.getElementById('val-width'),
    brightness: document.getElementById('val-brightness'),
    contrast:   document.getElementById('val-contrast'),
  };

  // ── Utilities ──────────────────────────────────────────────────────────────
  let toastTimer;
  function showToast(msg, duration = 2200) {
    toast.textContent = msg;
    toast.style.opacity = '1';
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => { toast.style.opacity = '0'; }, duration);
  }

  function setProgress(pct) {
    progressBar.style.display = pct < 100 ? 'block' : 'none';
    progressBar.style.width = pct + '%';
  }

  function sanitizeFilename(name) {
    return name.replace(/[^a-zA-Z0-9._\-]/g, '_').slice(0, 80);
  }

  // ── Persistence (localStorage) ─────────────────────────────────────────────
  // Safe wrappers — localStorage can be blocked in some browser/OS configs
  const Store = {
    get(key)        { try { return localStorage.getItem(key); }    catch { return null; } },
    set(key, value) { try { localStorage.setItem(key, value); }    catch { /* ignore */ } },
  };

  const SETTINGS_KEY = 'ascii_engine_settings';
  const THEME_KEY    = 'ascii_engine_theme';

  function saveSettings() {
    Store.set(SETTINGS_KEY, JSON.stringify({
      width:      ctrl.width.value,
      brightness: ctrl.brightness.value,
      contrast:   ctrl.contrast.value,
      charset:    ctrl.charset.value,
      invert:     ctrl.invert.checked,
      color:      ctrl.color.checked,
    }));
  }

  function loadSettings() {
    try {
      const s = JSON.parse(Store.get(SETTINGS_KEY) || 'null');
      if (!s) return;
      if (s.width      != null) { ctrl.width.value      = s.width;      valEl.width.textContent      = s.width; }
      if (s.brightness != null) { ctrl.brightness.value = s.brightness; valEl.brightness.textContent = s.brightness; }
      if (s.contrast   != null) { ctrl.contrast.value   = s.contrast;   valEl.contrast.textContent   = s.contrast; }
      if (s.charset    != null)   ctrl.charset.value    = s.charset;
      if (s.invert     != null)   ctrl.invert.checked   = s.invert;
      if (s.color      != null)   ctrl.color.checked    = s.color;
    } catch { /* corrupt storage — skip */ }
  }

  // ── Slider sync + persist ──────────────────────────────────────────────────
  ['width','brightness','contrast'].forEach(k => {
    ctrl[k].addEventListener('input', () => { valEl[k].textContent = ctrl[k].value; saveSettings(); });
  });
  ['charset','invert','color'].forEach(k => {
    ctrl[k].addEventListener('change', saveSettings);
  });

  // ── File validation & load ─────────────────────────────────────────────────
  function validateFile(file) {
    if (!file) return 'No file selected.';
    if (!ALLOWED_TYPES.has(file.type)) return 'Unsupported file type. Use PNG, JPEG, WEBP, GIF, or BMP.';
    if (file.size > MAX_FILE_SIZE) return `File too large. Max size is ${MAX_FILE_SIZE/1024/1024} MB.`;
    return null;
  }

  function loadFile(file) {
    const err = validateFile(file);
    if (err) { showToast('⚠ ' + err, 3500); return; }

    const safeName = sanitizeFilename(file.name);
    filenameDisp.textContent = safeName;

    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        canvas.width  = img.naturalWidth;
        canvas.height = img.naturalHeight;
        ctx.drawImage(img, 0, 0);
        imageLoaded = true;
        btnRender.disabled = false;
        URL.revokeObjectURL(img.src);
      };
      img.onerror = () => { showToast('⚠ Could not load image.', 3500); };
      img.src = e.target.result;
    };
    reader.onerror = () => { showToast('⚠ File read error.', 3500); };
    reader.readAsDataURL(file);
  }

  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) loadFile(file);
    e.target.value = '';
  });

  dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('dragover'); });
  dropzone.addEventListener('dragleave', ()  => { dropzone.classList.remove('dragover'); });
  dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file) loadFile(file);
  });

  // ── Core: image → ASCII ────────────────────────────────────────────────────
  function applyContrast(value, contrast, brightness) {
    // Apply brightness and contrast (0-255 range)
    let v = value * (brightness / 100);
    v = ((v / 255 - 0.5) * (contrast / 100) + 0.5) * 255;
    return Math.max(0, Math.min(255, v));
  }

  function renderASCII() {
    if (!imageLoaded) return;

    const t0 = performance.now();
    const cols      = parseInt(ctrl.width.value, 10);
    const brightness = parseInt(ctrl.brightness.value, 10);
    const contrast  = parseInt(ctrl.contrast.value, 10);
    const charset   = CHAR_SETS[ctrl.charset.value] || CHAR_SETS.standard;
    const invert    = ctrl.invert.checked;
    const useColor  = ctrl.color.checked;

    // Aspect ratio correction (chars are ~2x taller than wide)
    const aspect = canvas.height / canvas.width;
    const rows = Math.max(1, Math.round(cols * aspect * 0.45));

    // Scale canvas content to target grid
    const offscreen = document.createElement('canvas');
    offscreen.width  = cols;
    offscreen.height = rows;
    const offCtx = offscreen.getContext('2d', { willReadFrequently: true });
    offCtx.filter = `brightness(${brightness}%) contrast(${contrast}%)`;
    offCtx.drawImage(canvas, 0, 0, cols, rows);

    const imageData = offCtx.getImageData(0, 0, cols, rows);
    const data = imageData.data;

    setProgress(10);

    const lines = [];
    const colorLines = [];
    const len = charset.length - 1;

    for (let y = 0; y < rows; y++) {
      let line = '';
      const colorLine = [];

      for (let x = 0; x < cols; x++) {
        const i = (y * cols + x) * 4;
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        // Perceptual luminance (ITU-R BT.709)
        const lum = 0.2126 * r + 0.7152 * g + 0.0722 * b;
        const norm = invert ? 1 - (lum / 255) : lum / 255;
        const charIdx = Math.round(norm * len);
        const ch = charset[charIdx] || ' ';
        line += ch;

        if (useColor) {
          colorLine.push({ ch, r, g, b });
        }
      }

      lines.push(line);
      if (useColor) colorLines.push(colorLine);
      if (y % 20 === 0) setProgress(10 + Math.round((y / rows) * 80));
    }

    setProgress(90);
    lastResult = lines.join('\n');

    if (useColor) {
      // Build colored HTML
      const html = colorLines.map(row =>
        row.map(({ ch, r, g, b }) => {
          const safe = ch === '<' ? '&lt;' : ch === '>' ? '&gt;' : ch === '&' ? '&amp;' : ch;
          return `<span style="color:rgb(${r},${g},${b})">${safe}</span>`;
        }).join('')
      ).join('\n');
      asciiOut.innerHTML = html;
    } else {
      asciiOut.textContent = lastResult;
      asciiOut.style.color = '';
    }

    placeholder.style.display = 'none';
    asciiOut.style.display = 'block';

    setProgress(100);
    setTimeout(() => setProgress(100), 300);

    const t1 = performance.now();
    const ms = Math.round(t1 - t0);
    outputInfo.innerHTML = `<span>${cols}×${rows}</span> chars — ${lastResult.length.toLocaleString()} total`;
    perfInfo.textContent = `rendered in ${ms}ms`;

    btnCopy.disabled = false;
    btnDownload.disabled = false;
  }

  btnRender.addEventListener('click', () => {
    btnRender.disabled = true;
    // Yield to paint before heavy work
    requestAnimationFrame(() => {
      setTimeout(() => {
        renderASCII();
        btnRender.disabled = false;
      }, 16);
    });
  });

  // ── Copy ───────────────────────────────────────────────────────────────────
  btnCopy.addEventListener('click', async () => {
    if (!lastResult) return;
    try {
      await navigator.clipboard.writeText(lastResult);
      showToast('✓ Copied to clipboard');
    } catch {
      showToast('⚠ Copy failed — select text manually');
    }
  });

  // ── Download ───────────────────────────────────────────────────────────────
  btnDownload.addEventListener('click', () => {
    if (!lastResult) return;
    const blob = new Blob([lastResult], { type: 'text/plain;charset=utf-8' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = 'ascii-art.txt';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    showToast('✓ Downloaded ascii-art.txt');
  });

  // ── Zoom ───────────────────────────────────────────────────────────────────
  function applyZoom() {
    asciiOut.style.transform = `scale(${zoom})`;
    btnZoomReset.textContent = Math.round(zoom * 100) + '%';
  }

  btnZoomIn.addEventListener('click',    () => { zoom = Math.min(4, zoom + 0.1); applyZoom(); });
  btnZoomOut.addEventListener('click',   () => { zoom = Math.max(0.2, zoom - 0.1); applyZoom(); });
  btnZoomReset.addEventListener('click', () => { zoom = 1; applyZoom(); });

  // ── Theme Editor ───────────────────────────────────────────────────────────
  const DEFAULTS = { bg:'#0a0a0a', surface:'#111111', border:'#222222', accent:'#00ff88', accent2:'#ff3366', text:'#c8c8c8', dim:'#444444', ascii:'#00ff88' };

  const PRESETS = {
    default: { bg:'#0a0a0a', surface:'#111111', border:'#222222', accent:'#00ff88', accent2:'#ff3366', text:'#c8c8c8', dim:'#444444', ascii:'#00ff88' },
    light:   { bg:'#f5f5f0', surface:'#e8e8e3', border:'#cccccc', accent:'#0066cc', accent2:'#cc0044', text:'#1a1a1a', dim:'#888888', ascii:'#0066cc' },
    amber:   { bg:'#0f0a00', surface:'#1a1200', border:'#2a1f00', accent:'#ffb300', accent2:'#ff6600', text:'#ffe0a0', dim:'#6a5a20', ascii:'#ffb300' },
    cyan:    { bg:'#00080f', surface:'#001520', border:'#002030', accent:'#00e5ff', accent2:'#0080ff', text:'#a0d8ef', dim:'#205060', ascii:'#00e5ff' },
    rose:    { bg:'#0f0008', surface:'#1a0010', border:'#2a0018', accent:'#ff4d88', accent2:'#ff9900', text:'#ffc0d8', dim:'#602040', ascii:'#ff4d88' },
    matrix:  { bg:'#000000', surface:'#030a03', border:'#0a2a00', accent:'#39ff14', accent2:'#00ff88', text:'#a0ffa0', dim:'#1a4a1a', ascii:'#39ff14' },
  };

  const CSS_VAR_MAP = { bg:'--bg', surface:'--surface', border:'--border', accent:'--accent', accent2:'--accent2', text:'--text', dim:'--dim' };

  const themeInputs = {
    bg:      document.getElementById('tc-bg'),
    surface: document.getElementById('tc-surface'),
    border:  document.getElementById('tc-border'),
    accent:  document.getElementById('tc-accent'),
    accent2: document.getElementById('tc-accent2'),
    text:    document.getElementById('tc-text'),
    dim:     document.getElementById('tc-dim'),
    ascii:   document.getElementById('tc-ascii'),
  };

  const root = document.documentElement;

  function applyTheme(theme, persist = true) {
    Object.keys(CSS_VAR_MAP).forEach(k => {
      if (theme[k]) root.style.setProperty(CSS_VAR_MAP[k], theme[k]);
    });
    if (theme.ascii) asciiOut.style.color = theme.ascii;
    // Sync pickers
    Object.keys(themeInputs).forEach(k => {
      if (theme[k]) themeInputs[k].value = theme[k];
    });
    if (persist) Store.set(THEME_KEY, JSON.stringify(theme));
  }

  function loadTheme() {
    try {
      const raw = Store.get(THEME_KEY);
      if (!raw) return;
      const t = JSON.parse(raw);
      // Validate — only accept known hex color keys
      const isHex = v => typeof v === 'string' && /^#[0-9a-fA-F]{6}$/.test(v);
      const safe = {};
      Object.keys(DEFAULTS).forEach(k => { if (isHex(t[k])) safe[k] = t[k]; });
      applyTheme({ ...DEFAULTS, ...safe }, false);
    } catch { /* corrupt storage — skip */ }
  }

  // Live color picker updates — save on every change
  Object.keys(themeInputs).forEach(k => {
    themeInputs[k].addEventListener('input', () => {
      if (k === 'ascii') {
        asciiOut.style.color = themeInputs[k].value;
      } else {
        root.style.setProperty(CSS_VAR_MAP[k], themeInputs[k].value);
      }
      // Snapshot current picker state and persist
      const snapshot = {};
      Object.keys(themeInputs).forEach(j => { snapshot[j] = themeInputs[j].value; });
      Store.set(THEME_KEY, JSON.stringify(snapshot));
    });
  });

  // Preset buttons
  document.querySelectorAll('.preset-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const p = PRESETS[btn.dataset.preset];
      if (p) applyTheme(p);
    });
  });

  // Reset — clear stored theme and revert to defaults
  document.getElementById('theme-reset').addEventListener('click', () => {
    Store.set(THEME_KEY, JSON.stringify(DEFAULTS));
    applyTheme(DEFAULTS, false);
    showToast('✓ Theme reset to default');
  });

  // Open / close
  const themePanel   = document.getElementById('theme-panel');
  const themeOverlay = document.getElementById('theme-overlay');
  const themeBtn     = document.getElementById('theme-btn');
  const themeClose   = document.getElementById('theme-close');

  function openTheme()  { themePanel.classList.add('open'); themeOverlay.classList.add('open'); }
  function closeTheme() { themePanel.classList.remove('open'); themeOverlay.classList.remove('open'); }

  themeBtn.addEventListener('click', openTheme);
  themeClose.addEventListener('click', closeTheme);
  themeOverlay.addEventListener('click', closeTheme);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeTheme(); });

  // ── Boot: restore saved state ───────────────────────────────────────────────
  loadSettings();
  loadTheme();

  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      if (!btnRender.disabled) btnRender.click();
    }
  });

})();
</script>
</body>
</html>
